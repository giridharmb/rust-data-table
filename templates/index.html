<!DOCTYPE html>
<html>
<head>
    <title>DataTables Pagination</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>


    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-colors-2021.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-colors-2020.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-colors-win8.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- --------------------------------- ADD ONS | start ----------------------------------------------- -->

    <script src=""></script>
    <link rel="stylesheet" href="">

    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

    <!-- --------------------------------- ADD ONS | end ----------------------------------------------- -->


    <link rel="stylesheet" href="">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">

    <style>
    .custom-font {
        font-family: Roboto, Helvetica,sans-serif !important;
    }

    .my-body-margin {
        margin-left: 5px;
        margin-right: 5px;
        margin-top: 5px;
        margin-bottom: 5px;
    }

    .my-body-padding {
        padding-left: 5px;
        padding-right: 5px;
        padding-top: 5px;
        padding-bottom: 5px;
    }

    </style>

    <style>
    .loader {
        border: 5px solid #f3f3f3; /* Light grey */
        border-top: 5px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #id_loader_1 {
        display: none;
    }

    #id_loader_2 {
        display: none;
    }
    </style>

</head>

<body class="custom-font my-body-margin my-body-padding">

    <!-- ------------------------------------------------------------------------------------------- -->

    <div id="id_table_content_1">

    </div>
    <br/>

    <!-- ------------------------------------------------------------------------------------------- -->

    <div id="id_table_content_2">

    </div>
    <br/>

    <!-- ------------------------------------------------------------------------------------------- -->

    <script>
    function render_html_data_table_content(id_parent_div, header_name, header_color, id_checkbox, id_btn_export_csv, id_loader, id_result, id_dataTable, column_names) {
        var html_content = '';
        var i = 0;

        html_content = html_content + '<div class="w3-container ' + header_color + ' w3-center w3-round w3-border"><h3>' + header_name + '</h3></div>';
        html_content = html_content + '<div class="w3-container w3-right"> <input id="' + id_checkbox + '" name="' + id_checkbox + '" class="w3-check" checked="checked" type="checkbox">&nbsp;&nbsp;<label>Exact Search ( <b><u>Deselect</u></b> For Pattern Matching Based Search Across All Columns )</label></div> <br/><br/>';

        html_content = html_content + '<table>';
        html_content = html_content + '<tr>';
        html_content = html_content + '<td><button id="' + id_btn_export_csv + '" class="w3-button w3-black w3-round">Export Table (CSV)</button></td>';
        html_content = html_content + '<td>';
        html_content = html_content + '<div class="w3-container">';
        html_content = html_content + '<div id="' + id_loader + '" class="loader"></div>';
        html_content = html_content + '<div id="' + id_result + '"></div>';
        html_content = html_content + '</div>';
        html_content = html_content + '</td>';
        html_content = html_content + '</tr>';
        html_content = html_content + '</table>';

        html_content = html_content + '<br/>';

        html_content = html_content + '';

        html_content = html_content + '<table id="' + id_dataTable + '" class="display cell-border nowrap" style="width:100%">';

        html_content = html_content + '<thead>';
        html_content = html_content + '<tr>';
        for (i=0; i<column_names.length; i++) {
            html_content = html_content + '<th>' +  column_names[i] + '</th>';
        }
        html_content = html_content + '</tr>';
        html_content = html_content + '</thead>';

        html_content = html_content + '<tfoot>';
        html_content = html_content + '<tr>';
        for (i=0; i<column_names.length; i++) {
            html_content = html_content + '<th>' +  column_names[i] + '</th>';
        }
        html_content = html_content + '</tr>';
        html_content = html_content + '</tfoot>';

        html_content = html_content + '</table>';
        html_content = html_content + '<hr/>';

        $("#" + id_parent_div).html(html_content);
    }

    render_html_data_table_content(
        "id_table_content_1",
        "Random-Data-1",
        "w3-blue",
        "my_checkbox_1",
        "id_export_table_csv_1",
        "id_loader_1",
        "id_result_1",
        "dataTable_1",
        ["random_num", "random_float", "md5"]
    );

    render_html_data_table_content(
        "id_table_content_2",
        "Random-Data-2",
        "w3-blue",
        "my_checkbox_2",
        "id_export_table_csv_2",
        "id_loader_2",
        "id_result_2",
        "dataTable_2",
        ["my_date", "my_data"]
    );
    </script>
</body>
</html>


<script>
window.addEventListener('DOMContentLoaded', (event) => {
    render_ssr_jquery_datatable(
        "dataTable_1",
        "my_checkbox_1",
        "table1",
        [
            "random_num",
            "random_float",
            "md5"
        ],
        "id_table_content_1",
        []
    );

    render_ssr_jquery_datatable(
        "dataTable_2",
        "my_checkbox_2",
        "table2",
        [
            "my_date",
            "my_data"
        ],
        "id_table_content_2",
        []
    );

    handle_csv_export("id_export_table_csv_1", "id_loader_1", "id_table_content_1", "my_checkbox_1", "table1", "id_result_1");
    handle_csv_export("id_export_table_csv_2", "id_loader_2", "id_table_content_2", "my_checkbox_2", "table2", "id_result_2");
});
</script>

<script>
function handle_csv_export(id_button_export, id_loader, id_table_content, id_checkbox, id_table, id_result) {
    var export_table_csv = document.getElementById(id_button_export);
    var loader = document.getElementById(id_loader);

    export_table_csv.onclick = function () {
        loader.style.display = "block";

        // returns the search string in the search box
        var search_str = '';
        var search_str_tmp1 = $("#"+id_table_content).find('input[type="search"]')[0].value;
        var search_str_tmp2 = search_str_tmp1.trim();
        if (search_str_tmp2 === '') {
            search_str = '___'; // search all
        } else {
            search_str = search_str_tmp2;
        }
        console.log("--[search_str]--");
        console.log(search_str);

        // returns true or false
        var exact_search = $("#"+id_checkbox).is(":checked");
        console.log("--[exact_search]--");
        console.log(exact_search);

        var pattern_match = "";
        if (exact_search === true) {
            pattern_match = "exact";
        } else {
            pattern_match = "like";
        }

        console.log("--[pattern_match]--");
        console.log(pattern_match);

        var payload = JSON.stringify({
            "table_name": id_table, // ---> make a note of this !!
            "pattern_match": pattern_match,
            "search_string": search_str
        });

        console.log("--[payload]--");
        console.log(payload);

        $.ajax({
            type: "POST",
            dataType: "JSON",
            contentType: "application/json",
            timeout: 60000,
            data: payload,
            url: window.location.origin + "/export_csv",
            success: function (resp) {
                console.log("success : " + resp);
                loader.style.display = "none";
                var csv_url = window.location.origin + '/' + resp["message"];
                console.log(csv_url);

                var status_code = resp["status"];
                var total_rows = resp["rows"];
                var time_taken_for_export = resp["time_taken_for_export"];

                var result = '<a href="' + csv_url + '">' + csv_url + '</a>&nbsp;&nbsp;&nbsp; Status Code ('+status_code+') , Time Taken To Export (<b>'+total_rows+'</b>) Rows => (<b>' + time_taken_for_export + '</b>) seconds';

                console.log(result);

                $("#"+id_result).html(result);
            },
            error: function (resp) {
                console.log("error : " + resp);
                loader.style.display = "none";
            }
        });
    };
}
</script>

<script>
function get_columns(column_name_list) {
    var i=0;
    var columns = [];
    for(i=0;i<column_name_list.length; i++) {
        var column_data = {"data": column_name_list[i]}
        columns.push(column_data)
    }
    return columns;
}

function get_column_defs(total_column_length) {
    var i=0;
    var column_defs = [];
    for(i=0;i<total_column_length; i++) {
        var column_def = {"targets": i, "className": "dt-body-center"};
        column_defs.push(column_def);
    }
    return column_defs;
}

function render_ssr_jquery_datatable(id_data_table, id_checkbox, table_name, column_names, id_table_content, column_indexes_which_are_int) {
    var data_table_object = {};
    var my_columns = get_columns(column_names);
    var my_column_defs = get_column_defs(column_names.length);

    data_table_object = $('#'+id_data_table).DataTable({
        "lengthMenu": [10, 50, 100, 250, 500],
        "pageLength": 10,
        "processing": true,
        "serverSide": true,
        "deferRender": true,
        "searching": true,
        "scrollY": "400px",
        "sScrollX": '100%',
        // "dom": "Bfrtip",
        "dom": "lfiprtip",
        "ajax": {
            "url": '/query',
            "type" : "POST",
            "data" : function(d) {
                d.exactsearch = $("#"+ id_checkbox).is(":checked");
                d.tablename = table_name; // ---> make a note of this !!
            }
        },
        "drawCallback": function(oSettings, json){

        },
        "columns" : my_columns,
        "language" : {
            "processing": '<div class="lds-dual-ring"></div>'
        },
        'columnDefs': my_column_defs
    }); // $('#'+id_data_table).DataTable({


    $("#"+id_table_content).find('input[type="search"]').css("text-align", "center");
    $("#"+id_table_content).find('input[type="search"]').css("width", "700px");
    $("#"+id_table_content).find('input[type="search"]').css("background-color", "#eaf9ff");

    $('#'+id_table_content).find('input[type="search"]').off();


    $('#'+id_table_content).find('input[type="search"]').on('keyup', function(e) {
        if(e.keyCode === 13) {

            console.log("--[searching for this.value]--");
            console.log(this.value);

            var stringToSearch = this.value;

            if(stringToSearch.includes("+") === true && stringToSearch.includes("|")) {
                alert("Your Search Cannot Include BOTH '+' and '|' (OR) Search Characters.");
                return false;
            }
            data_table_object.search( this.value ).draw();
        }
    });
}
</script>
